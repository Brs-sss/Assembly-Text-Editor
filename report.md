# 汇编与编译原理 文本编辑器 中期提交说明文档

> 白润声 姚润茂 方钧同

## 开发环境

本应用采用win32汇编开发，使用了`masm32`开发工具和`Irvine32`链接库

## 项目中期目标
中期目标：
1. 实现基本的文本输入，包括键盘输入、删除和光标等；
2. 实现菜单栏，包含文件、编辑等需要交互选项；
3. 实现文件交互，支持打开、编辑、保存文件。

## 实现原理

基本实现原理与win32编程相同，即代码的实现流程为：1.获取程序实例句柄；2.创建主窗口；3.创建菜单栏、子窗口等附加内容；4.开始消息循环，处理消息。

具体功能的实现如下：
### 主窗口创建
首先，我们需要创建主窗口。首先是注册窗口类，我们需要对`wc`的`cbSize`、`lpfnWndProc`、`hbrBackground`、`hIcon`等一系列窗口、界面参数进行初始化。利用wc注册类后，调用`CreateWindowEx`创建主窗口。

### 菜单栏的添加
菜单栏添加的结构如下：1.调用`CreateMenu`创建主菜单栏；2.调用`CreatePopupMenu`创建弹窗菜单栏；3.不断调用参数为`MF_STRING`的`AppendMenu`，向弹窗菜单栏中添加点击选项并绑定ID；4.调用参数为`MF_POPUP`的`AppendMenu`，向主菜单添加弹窗栏；5.重复2~4步，直至满足预设菜单栏结构。

菜单栏相应的逻辑余下：点击菜单栏item后，消息循环会收到WM_COMMAND消息，根据参数传送的菜单栏ID，可以获知是哪一选项被点击，并作出相应处理。

### Edit控件的使用
想要利用Edit控件进行文本的编辑，需要让其成为主窗口的子窗口。因此创建时，需要将`CreateWindowEx`的`hWndParent`参数设置为主窗口句柄。同时，在窗口风格中，还需要设置`WS_CHILD`这一选项。

更多的Edit控件的细节设置如下：通过`ES_LEFT`设置左对齐；通过`WS_VSCROLL`和`ES_AUTOVSCROLL`设置滚动栏及其表现；通过`ES_MULTILINE`设置多行编辑；初始大小与`GetClientRect`获取的`rect`一致。

另外，为了保证控件的大小持续覆盖主窗口，我们需要处理`WM_SIZE`消息。当消息循环接收到这一消息时，通过`lParam`的高、低16位获取更改后主窗口的长宽，调用`MoveWindow`实现对Edit尺寸的更改。

### 打开和保存

打开和保存的第一步相同，均为调用对应的窗口`GetOpenFileName`与`GetSaveFileName`，以获得要打开（保存）的文件名。这一步的成功与否保存在`eax`中，详细信息储存在`OPENFILENAME`结构体`ofn`中。之后利用循环将文件名存到`szFileName`这一变量中，以便后续使用。

获取文件名后，需要调用`CreateFile`创建对应的文件名，也即实际上的打开文件过程，若打开成功则将`eax`置为对应的文件句柄，因此正式的读取文件或写入文件前应当判断句柄是否合法，也即是否打开成功。

整个应用当前编辑的文本保存在`curText`变量中，打开文件时先经过一个循环将将`curText`字符数组的每个值都赋0，即清空该字符串，之后调用`ReadFile`过程把文件的内容读到`curText`中，然后通过调用`SendMessage`接口把`curText`字符串输出到edit控件上，完成显示；保存文件时没有使用`curText`字符串，而是选择使用`SendMessage`接口获取edit控件内的当前内容，并根据内容大小相应分配足够的空间以临时缓存这部分内容，之后通过调用`WriteFile`过程将缓冲区里的内容写入本地文件。具体的操作完成后，需要调用`CloseHandle`关闭文件句柄，否则可能会导致泄露。

## 小组分工
- 白润声 - 主窗口，Edit子窗口和消息循环的创建
- 方钧同 - 文件的打开、读取操作
- 姚润茂 - Edit控件的字符串操作

